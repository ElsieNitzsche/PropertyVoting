# Proposal æ˜¾ç¤ºå’Œåˆ›å»ºé€»è¾‘ä¿®å¤å®Œæˆ âœ…

## ä¿®å¤å†…å®¹

### é—®é¢˜æè¿°
- âŒ æ— æ³•åˆ›å»ºæ–° proposal (æç¤ºå·²æœ‰ proposal)
- âŒ æ— æ³•æ˜¾ç¤ºå·²æœ‰ proposal (æ˜¾ç¤ºä¸ºç©º)

### æ ¹æœ¬åŸå› 
å‰ç«¯é€»è¾‘æ··æ·†äº†ä¸‰ç§çŠ¶æ€:
1. **åˆçº¦çš„ `isActive` çŠ¶æ€** - ææ¡ˆæ˜¯å¦è¢«ç®¡ç†å‘˜æ­£å¼ç»“æŸ
2. **å®æ—¶çš„æŠ•ç¥¨çŠ¶æ€** - å½“å‰æ—¶é—´æ˜¯å¦åœ¨æŠ•ç¥¨æœŸå†…
3. **ææ¡ˆæ˜¯å¦å­˜åœ¨** - `currentProposal` è®¡æ•°å™¨

### ä¿®å¤æ–¹æ¡ˆ

#### 1. ä¼˜åŒ–åˆ›å»º Proposal é€»è¾‘ (index.html:1142-1180)

**ä¿®å¤å‰:**
```javascript
if (isActiveVoting || !resultsRevealed) {
    // é˜»æ­¢åˆ›å»º
}
```

**ä¿®å¤å:**
```javascript
if (freshIsActive) {
    // åªè¦åˆçº¦çš„ isActive ä¸º trueï¼Œå°±ä¸å…è®¸åˆ›å»ºæ–°ææ¡ˆ
    // è¿™æ­£ç¡®å¯¹åº”äº†åˆçº¦çš„ require(!proposals[currentProposal].isActive)
    if (isActiveVoting) {
        // ææ¡ˆè¿˜åœ¨æŠ•ç¥¨æœŸ
        message = "ææ¡ˆè¿˜åœ¨æŠ•ç¥¨æœŸï¼Œè¯·ç­‰å¾…æŠ•ç¥¨ç»“æŸ";
    } else {
        // æŠ•ç¥¨æœŸç»“æŸä½†æœªå…³é—­
        message = "ææ¡ˆéœ€è¦ç®¡ç†å‘˜ç‚¹å‡»'ç»“æŸææ¡ˆ'æŒ‰é’®";
    }
}
```

#### 2. ä¼˜åŒ–æ˜¾ç¤º Proposal é€»è¾‘ (index.html:1240-1321)

**ä¿®å¤å‰:**
```javascript
if (isVotingActive && currentProposalId > 0) {
    // åªæ˜¾ç¤ºæŠ•ç¥¨æœŸå†…çš„ææ¡ˆ
}
```

**ä¿®å¤å:**
```javascript
if (currentProposalId > 0 && (isActive || isVotingActive)) {
    // æ˜¾ç¤ºå­˜åœ¨ä¸”æ¿€æ´»çš„ææ¡ˆ
    if (isVotingActive) {
        // æŠ•ç¥¨æœŸå†… - æ˜¾ç¤ºæŠ•ç¥¨æŒ‰é’®
        æ˜¾ç¤º: "Active" å¾½ç«  + æŠ•ç¥¨æŒ‰é’®
    } else {
        // æŠ•ç¥¨æœŸç»“æŸä½†æœªå…³é—­ - æ˜¾ç¤ºç­‰å¾…ç®¡ç†å‘˜æ“ä½œ
        æ˜¾ç¤º: "Awaiting Closure" å¾½ç«  + ç®¡ç†å‘˜æç¤º
    }
}
```

## ä¸‰ç§ææ¡ˆçŠ¶æ€åŠå¯¹åº”æ˜¾ç¤º

### çŠ¶æ€ 1: æŠ•ç¥¨æœŸå†… (Active)
**æ¡ä»¶:** `isActive = true` && `isVotingActive = true`

**æ˜¾ç¤º:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ææ¡ˆæ ‡é¢˜              [Active] â”‚
â”‚                                 â”‚
â”‚ æè¿°...                        â”‚
â”‚                                 â”‚
â”‚ â±ï¸ Time Remaining: 23h 45m     â”‚
â”‚                                 â”‚
â”‚ [YES]           [NO]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ“ä½œ:**
- âœ… ç”¨æˆ·å¯ä»¥æŠ•ç¥¨
- âŒ ä¸èƒ½åˆ›å»ºæ–°ææ¡ˆ
- âŒ ä¸èƒ½ç»“æŸææ¡ˆ(æ—¶é—´æœªåˆ°)

---

### çŠ¶æ€ 2: æŠ•ç¥¨æœŸç»“æŸï¼Œç­‰å¾…å…³é—­ (Awaiting Closure)
**æ¡ä»¶:** `isActive = true` && `isVotingActive = false`

**æ˜¾ç¤º:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ææ¡ˆæ ‡é¢˜      [Awaiting Closure]  â”‚
â”‚                                     â”‚
â”‚ æè¿°...                            â”‚
â”‚                                     â”‚
â”‚ â° Voting Period Ended             â”‚
â”‚    Awaiting Admin Closure           â”‚
â”‚                                     â”‚
â”‚ ğŸ“¢ Admin Action Required           â”‚
â”‚ ç®¡ç†å‘˜å¿…é¡»ç‚¹å‡»"ç»“æŸææ¡ˆ"æŒ‰é’®       â”‚
â”‚ ä»¥æ­ç¤ºç»“æœå¹¶å…è®¸åˆ›å»ºæ–°ææ¡ˆ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ“ä½œ:**
- âŒ ç”¨æˆ·ä¸èƒ½æŠ•ç¥¨(æ—¶é—´å·²è¿‡)
- âŒ ä¸èƒ½åˆ›å»ºæ–°ææ¡ˆ(æ—§ææ¡ˆæœªå…³é—­)
- âœ… **ç®¡ç†å‘˜å¯ä»¥ç‚¹å‡»"ğŸ›‘ End Expired Proposal"**

---

### çŠ¶æ€ 3: å·²å®Œæˆ (Completed)
**æ¡ä»¶:** `isActive = false`

**æ˜¾ç¤º:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ææ¡ˆæ ‡é¢˜      [Voting Ended]   â”‚
â”‚                                 â”‚
â”‚ æè¿°...                        â”‚
â”‚                                 â”‚
â”‚ Voting Period Ended            â”‚
â”‚ Admin can create new proposal  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Voting Results:
YES: 12 votes (60%)
NO: 8 votes (40%)
Proposal APPROVED
```

**æ“ä½œ:**
- âŒ ç”¨æˆ·ä¸èƒ½æŠ•ç¥¨
- âœ… **å¯ä»¥åˆ›å»ºæ–°ææ¡ˆ**
- âŒ ä¸èƒ½å†ç»“æŸ(å·²ç»ç»“æŸ)

---

## åˆçº¦çŠ¶æ€è½¬æ¢æµç¨‹

```
[åˆ›å»ºææ¡ˆ]
    â†“
isActive=true, æŠ•ç¥¨æœŸå†…
(çŠ¶æ€1: Active)
    â†“
æŠ•ç¥¨æœŸç»“æŸ
    â†“
isActive=true, æŠ•ç¥¨æœŸå¤–
(çŠ¶æ€2: Awaiting Closure) â† è¿™æ˜¯ä½ é‡åˆ°é—®é¢˜çš„çŠ¶æ€
    â†“
ç®¡ç†å‘˜è°ƒç”¨ endProposal()
    â†“
isActive=false
(çŠ¶æ€3: Completed)
    â†“
å¯ä»¥åˆ›å»ºæ–°ææ¡ˆ
```

## ä½¿ç”¨æŒ‡å—

### æ™®é€šç”¨æˆ·æŠ•ç¥¨æµç¨‹
1. **è¿æ¥é’±åŒ…**
2. **æ³¨å†Œå±…æ°‘** (å¦‚æœæœªæ³¨å†Œ)
3. **æŸ¥çœ‹å½“å‰ææ¡ˆ**
   - å¦‚æœæ˜¾ç¤º "Active" - å¯ä»¥æŠ•ç¥¨
   - å¦‚æœæ˜¾ç¤º "Awaiting Closure" - ç­‰å¾…ç®¡ç†å‘˜ç»“æŸ
   - å¦‚æœæ˜¾ç¤º "No active voting" - ç­‰å¾…æ–°ææ¡ˆ
4. **æŠ•ç¥¨** (ä»…åœ¨çŠ¶æ€1å¯ç”¨)

### ç®¡ç†å‘˜æ“ä½œæµç¨‹

#### åˆ›å»ºæ–°ææ¡ˆ
```
æ£€æŸ¥å½“å‰çŠ¶æ€:
  - çŠ¶æ€1 (Active)?
      â†’ âŒ ç­‰å¾…æŠ•ç¥¨æœŸç»“æŸ
  - çŠ¶æ€2 (Awaiting Closure)?
      â†’ âŒ å…ˆç‚¹å‡»"ğŸ›‘ End Expired Proposal"
  - çŠ¶æ€3 (Completed)?
      â†’ âœ… å¯ä»¥åˆ›å»ºæ–°ææ¡ˆ
```

#### ç»“æŸææ¡ˆ
```
æ£€æŸ¥å½“å‰çŠ¶æ€:
  - çŠ¶æ€1 (Active)?
      â†’ âš ï¸ æŠ•ç¥¨æœŸæœªç»“æŸ(å¯å¼ºåˆ¶ç»“æŸä½†ä¸æ¨è)
  - çŠ¶æ€2 (Awaiting Closure)?
      â†’ âœ… ç‚¹å‡»"ğŸ›‘ End Expired Proposal"
  - çŠ¶æ€3 (Completed)?
      â†’ âŒ å·²ç»ç»“æŸ
```

## è°ƒè¯•å‘½ä»¤

åœ¨æµè§ˆå™¨æ§åˆ¶å°(F12)è¿è¡Œ:

```javascript
// æŸ¥çœ‹å½“å‰çŠ¶æ€
async function checkStatus() {
    const [id, title, desc, isActive, start, end, votes] =
        await contract.getCurrentProposalInfo();
    const isVoting = await contract.isVotingActive(id);

    console.log('Proposal ID:', id.toString());
    console.log('Title:', title);
    console.log('Is Active (contract):', isActive);
    console.log('Is Voting Active (time):', isVoting);
    console.log('Current State:',
        isActive && isVoting ? 'State 1: Active' :
        isActive && !isVoting ? 'State 2: Awaiting Closure' :
        'State 3: Completed'
    );
}
checkStatus();
```

## å¿«é€Ÿä¿®å¤æ­¥éª¤

å¦‚æœä½ ç°åœ¨é‡åˆ°"æ—¢ä¸èƒ½åˆ›å»ºä¹Ÿä¸èƒ½æ˜¾ç¤º"çš„é—®é¢˜:

### Step 1: åˆ·æ–°é¡µé¢
è®¿é—®: http://localhost:1251/

### Step 2: è¿æ¥é’±åŒ…
ç‚¹å‡» "Connect MetaMask Wallet"

### Step 3: æŸ¥çœ‹çŠ¶æ€
ç‚¹å‡» "ğŸ” Debug Contract State"ï¼Œåœ¨æ§åˆ¶å°æŸ¥çœ‹:
```
Is Active (from contract): true/false
Is Voting Active: true/false
```

### Step 4: æ ¹æ®çŠ¶æ€æ“ä½œ

**å¦‚æœ `Is Active: true, Is Voting Active: false`**
```
â†’ è¿™æ˜¯çŠ¶æ€2ï¼Œéœ€è¦ç®¡ç†å‘˜æ“ä½œ:
1. ç‚¹å‡» "ğŸ›‘ End Expired Proposal"
2. åœ¨ MetaMask ç¡®è®¤äº¤æ˜“
3. ç­‰å¾…äº¤æ˜“ç¡®è®¤
4. é¡µé¢ä¼šè‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºç»“æœ
5. ç°åœ¨å¯ä»¥åˆ›å»ºæ–°ææ¡ˆäº†
```

**å¦‚æœ `Is Active: false`**
```
â†’ è¿™æ˜¯çŠ¶æ€3ï¼Œå¯ä»¥ç›´æ¥åˆ›å»º:
1. å¡«å†™ææ¡ˆä¿¡æ¯
2. ç‚¹å‡» "Create New Proposal"
```

**å¦‚æœ `Is Active: true, Is Voting Active: true`**
```
â†’ è¿™æ˜¯çŠ¶æ€1ï¼Œææ¡ˆæ­£åœ¨è¿›è¡Œ:
1. åº”è¯¥èƒ½çœ‹åˆ°ææ¡ˆæ˜¾ç¤º
2. å¦‚æœçœ‹ä¸åˆ°ï¼Œç‚¹å‡» "ğŸ”„ Refresh Status"
3. å¯ä»¥æŠ•ç¥¨ä½†ä¸èƒ½åˆ›å»ºæ–°ææ¡ˆ
```

## æµ‹è¯•åœºæ™¯

### æµ‹è¯•1: åˆ›å»ºå’ŒæŠ•ç¥¨
1. åˆ›å»ºææ¡ˆ(æŠ•ç¥¨æœŸè®¾ä¸º24å°æ—¶)
2. æ³¨å†Œç”¨æˆ·å¹¶æŠ•ç¥¨
3. ç¡®è®¤ææ¡ˆæ˜¾ç¤ºä¸º"Active"

### æµ‹è¯•2: è¿‡æœŸä½†æœªç»“æŸ
1. ç­‰å¾…æŠ•ç¥¨æœŸç»“æŸ(æˆ–åˆ›å»º1åˆ†é’Ÿçš„æµ‹è¯•ææ¡ˆ)
2. ç¡®è®¤ææ¡ˆæ˜¾ç¤ºä¸º"Awaiting Closure"
3. ç¡®è®¤æ— æ³•åˆ›å»ºæ–°ææ¡ˆ
4. ç®¡ç†å‘˜ç‚¹å‡»"End Expired Proposal"
5. ç¡®è®¤ææ¡ˆæ˜¾ç¤ºä¸º"Voting Ended"
6. ç¡®è®¤å¯ä»¥åˆ›å»ºæ–°ææ¡ˆ

### æµ‹è¯•3: çŠ¶æ€åˆ·æ–°
1. åœ¨ä»»ä½•çŠ¶æ€ç‚¹å‡»"ğŸ”„ Refresh Status"
2. ç¡®è®¤çŠ¶æ€æ­£ç¡®æ›´æ–°

## æ–‡ä»¶ä¿®æ”¹è®°å½•

- `index.html` (line 1142-1180): åˆ›å»ºææ¡ˆé€»è¾‘
- `index.html` (line 1240-1321): æ˜¾ç¤ºææ¡ˆé€»è¾‘

## æŠ€æœ¯ç»†èŠ‚

### åˆçº¦çŠ¶æ€å­—æ®µ
```solidity
struct VotingProposal {
    bool isActive;      // ç”±ç®¡ç†å‘˜æ§åˆ¶ï¼ŒendProposal()è®¾ä¸ºfalse
    uint256 startTime;  // å¼€å§‹æ—¶é—´æˆ³
    uint256 endTime;    // ç»“æŸæ—¶é—´æˆ³
    // ... å…¶ä»–å­—æ®µ
}
```

### å‰ç«¯çŠ¶æ€åˆ¤æ–­
```javascript
// åˆçº¦çŠ¶æ€
const isActive = proposals[currentProposal].isActive;

// å®æ—¶è®¡ç®—
const isVotingActive =
    proposals[proposalId].isActive &&
    block.timestamp <= proposals[proposalId].endTime;
```

---

**ä¿®å¤æ—¶é—´:** 2025-10-23
**æµ‹è¯•çŠ¶æ€:** âœ… å·²å®Œæˆ
**éƒ¨ç½²çŠ¶æ€:** âœ… æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:1251
