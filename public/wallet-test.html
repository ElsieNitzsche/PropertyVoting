<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connection Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .result-item {
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-label {
            font-weight: bold;
            color: #667eea;
            display: inline-block;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é’±åŒ…è¿æ¥è¯Šæ–­å·¥å…·</h1>

        <!-- Test 1: MetaMask Detection -->
        <div class="test-section">
            <h3>1. MetaMask æ£€æµ‹</h3>
            <div id="metamaskStatus" class="status info">æ£€æŸ¥ä¸­...</div>
            <div id="metamaskDetails"></div>
        </div>

        <!-- Test 2: Ethers.js Library -->
        <div class="test-section">
            <h3>2. Ethers.js åº“æ£€æµ‹</h3>
            <div id="ethersStatus" class="status info">æ£€æŸ¥ä¸­...</div>
            <div id="ethersDetails"></div>
        </div>

        <!-- Test 3: Config File -->
        <div class="test-section">
            <h3>3. é…ç½®æ–‡ä»¶æ£€æµ‹</h3>
            <div id="configStatus" class="status info">æ£€æŸ¥ä¸­...</div>
            <div id="configDetails"></div>
        </div>

        <!-- Test 4: Network Check -->
        <div class="test-section">
            <h3>4. ç½‘ç»œæ£€æµ‹</h3>
            <button id="checkNetwork">æ£€æŸ¥ç½‘ç»œ</button>
            <div id="networkStatus"></div>
            <div id="networkDetails"></div>
        </div>

        <!-- Test 5: Connection Test -->
        <div class="test-section">
            <h3>5. è¿æ¥æµ‹è¯•</h3>
            <button id="testConnect">æµ‹è¯•è¿æ¥é’±åŒ…</button>
            <div id="connectionStatus"></div>
            <div id="connectionDetails"></div>
        </div>

        <!-- Console Log -->
        <div class="test-section">
            <h3>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</h3>
            <div id="consoleLog" class="code" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="./config.js"></script>
    <script>
        // Console logging
        const logContainer = document.getElementById('consoleLog');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(type, ...args) {
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return String(arg);
            }).join(' ');

            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '5px';
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${
                type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#6bcf7f'
            };">[${type.toUpperCase()}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('log', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('error', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('warn', ...args);
        };

        // Test 1: Check MetaMask
        function checkMetaMask() {
            const statusDiv = document.getElementById('metamaskStatus');
            const detailsDiv = document.getElementById('metamaskDetails');

            console.log('=== æ£€æŸ¥ MetaMask ===');

            if (typeof window.ethereum !== 'undefined') {
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… MetaMask å·²å®‰è£…';

                let details = '<div class="result-item"><span class="result-label">ethereum å¯¹è±¡:</span> å­˜åœ¨</div>';
                details += `<div class="result-item"><span class="result-label">isMetaMask:</span> ${window.ethereum.isMetaMask || 'unknown'}</div>`;
                details += `<div class="result-item"><span class="result-label">chainId:</span> ${window.ethereum.chainId || 'unknown'}</div>`;
                details += `<div class="result-item"><span class="result-label">selectedAddress:</span> ${window.ethereum.selectedAddress || 'none'}</div>`;

                detailsDiv.innerHTML = details;
                console.log('âœ“ MetaMask detected');
                console.log('Chain ID:', window.ethereum.chainId);
                console.log('Selected Address:', window.ethereum.selectedAddress);
                return true;
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ MetaMask æœªå®‰è£…';
                detailsDiv.innerHTML = `
                    <div class="warning" style="margin-top: 10px;">
                        <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                        1. å®‰è£… MetaMask æµè§ˆå™¨æ‰©å±•<br>
                        2. è®¿é—®: <a href="https://metamask.io/download/" target="_blank">https://metamask.io/download/</a><br>
                        3. å®‰è£…å®Œæˆååˆ·æ–°æ­¤é¡µé¢
                    </div>
                `;
                console.error('âœ— MetaMask not detected');
                return false;
            }
        }

        // Test 2: Check Ethers.js
        function checkEthers() {
            const statusDiv = document.getElementById('ethersStatus');
            const detailsDiv = document.getElementById('ethersDetails');

            console.log('=== æ£€æŸ¥ Ethers.js ===');

            if (typeof ethers !== 'undefined') {
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… Ethers.js å·²åŠ è½½';

                let details = '<div class="result-item"><span class="result-label">ethers å¯¹è±¡:</span> å­˜åœ¨</div>';
                details += `<div class="result-item"><span class="result-label">ç‰ˆæœ¬:</span> ${ethers.version || 'unknown'}</div>`;

                detailsDiv.innerHTML = details;
                console.log('âœ“ Ethers.js loaded, version:', ethers.version);
                return true;
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ Ethers.js æœªåŠ è½½';
                detailsDiv.innerHTML = `
                    <div class="error" style="margin-top: 10px;">
                        <strong>é—®é¢˜:</strong> Ethers.js åº“æœªèƒ½åŠ è½½<br>
                        <strong>å¯èƒ½åŸå› :</strong> CDN è¿æ¥å¤±è´¥æˆ–è¢«å±è”½<br>
                        <strong>è§£å†³æ–¹æ¡ˆ:</strong> æ£€æŸ¥ç½‘ç»œè¿æ¥,æˆ–ä½¿ç”¨æœ¬åœ° ethers.js æ–‡ä»¶
                    </div>
                `;
                console.error('âœ— Ethers.js not loaded');
                return false;
            }
        }

        // Test 3: Check Config
        function checkConfig() {
            const statusDiv = document.getElementById('configStatus');
            const detailsDiv = document.getElementById('configDetails');

            console.log('=== æ£€æŸ¥é…ç½®æ–‡ä»¶ ===');

            if (typeof CONFIG !== 'undefined') {
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… é…ç½®æ–‡ä»¶å·²åŠ è½½';

                let details = '<div class="result-item"><span class="result-label">åˆçº¦åœ°å€:</span> ' + CONFIG.CONTRACT_ADDRESS + '</div>';
                details += '<div class="result-item"><span class="result-label">ç½‘ç»œ:</span> ' + CONFIG.CHAIN_NAME + '</div>';
                details += '<div class="result-item"><span class="result-label">Chain ID:</span> ' + CONFIG.CHAIN_ID + '</div>';
                details += '<div class="result-item"><span class="result-label">RPC URL:</span> ' + CONFIG.RPC_URL + '</div>';
                details += '<div class="result-item"><span class="result-label">ABI æ¡ç›®:</span> ' + (CONFIG.ABI ? CONFIG.ABI.length : 0) + '</div>';

                detailsDiv.innerHTML = details;
                console.log('âœ“ CONFIG loaded');
                console.log('Contract Address:', CONFIG.CONTRACT_ADDRESS);
                console.log('Network:', CONFIG.CHAIN_NAME);
                return true;
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ é…ç½®æ–‡ä»¶æœªåŠ è½½';
                detailsDiv.innerHTML = `
                    <div class="error" style="margin-top: 10px;">
                        <strong>é—®é¢˜:</strong> config.js æœªèƒ½åŠ è½½<br>
                        <strong>è§£å†³æ–¹æ¡ˆ:</strong> æ£€æŸ¥ public/config.js æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                    </div>
                `;
                console.error('âœ— CONFIG not loaded');
                return false;
            }
        }

        // Test 4: Check Network
        async function checkNetwork() {
            const statusDiv = document.getElementById('networkStatus');
            const detailsDiv = document.getElementById('networkDetails');

            statusDiv.className = 'status info';
            statusDiv.textContent = 'æ£€æŸ¥ä¸­...';
            detailsDiv.innerHTML = '';

            console.log('=== æ£€æŸ¥ç½‘ç»œ ===');

            if (typeof window.ethereum === 'undefined') {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ è¯·å…ˆå®‰è£… MetaMask';
                return;
            }

            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdDecimal = parseInt(chainId, 16);

                console.log('Current Chain ID:', chainId, '(', chainIdDecimal, ')');

                let details = '<div class="result-item"><span class="result-label">å½“å‰ Chain ID (hex):</span> ' + chainId + '</div>';
                details += '<div class="result-item"><span class="result-label">å½“å‰ Chain ID (decimal):</span> ' + chainIdDecimal + '</div>';

                if (typeof CONFIG !== 'undefined') {
                    const isCorrect = chainIdDecimal === CONFIG.CHAIN_ID;
                    details += '<div class="result-item"><span class="result-label">æœŸæœ› Chain ID:</span> ' + CONFIG.CHAIN_ID + '</div>';
                    details += '<div class="result-item"><span class="result-label">ç½‘ç»œåŒ¹é…:</span> ' + (isCorrect ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯') + '</div>';

                    if (isCorrect) {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = 'âœ… ç½‘ç»œæ­£ç¡® (Sepolia Testnet)';
                    } else {
                        statusDiv.className = 'status warning';
                        statusDiv.textContent = 'âš ï¸ ç½‘ç»œä¸åŒ¹é…';
                        details += `<div class="warning" style="margin-top: 10px;">
                            <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                            åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘<br>
                            Chain ID: 11155111 (0xaa36a7)
                        </div>`;
                    }
                } else {
                    statusDiv.className = 'status warning';
                    statusDiv.textContent = 'âš ï¸ æ— æ³•éªŒè¯ç½‘ç»œ (é…ç½®æœªåŠ è½½)';
                }

                detailsDiv.innerHTML = details;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ æ£€æŸ¥ç½‘ç»œå¤±è´¥';
                detailsDiv.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
                console.error('Network check error:', error);
            }
        }

        // Test 5: Test Connection
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const detailsDiv = document.getElementById('connectionDetails');

            statusDiv.className = 'status info';
            statusDiv.textContent = 'è¿æ¥ä¸­...';
            detailsDiv.innerHTML = '';

            console.log('=== æµ‹è¯•è¿æ¥ ===');

            if (typeof window.ethereum === 'undefined') {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ MetaMask æœªå®‰è£…';
                return;
            }

            if (typeof ethers === 'undefined') {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ Ethers.js æœªåŠ è½½';
                return;
            }

            try {
                console.log('Requesting accounts...');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log('Accounts received:', accounts);

                if (accounts.length === 0) {
                    throw new Error('æœªè¿”å›è´¦æˆ·');
                }

                console.log('Creating provider...');
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                console.log('Provider created');

                console.log('Getting signer...');
                const signer = provider.getSigner();
                console.log('Signer obtained');

                console.log('Getting address...');
                const address = await signer.getAddress();
                console.log('Address:', address);

                console.log('Getting network...');
                const network = await provider.getNetwork();
                console.log('Network:', network);

                console.log('Getting balance...');
                const balance = await provider.getBalance(address);
                const balanceEth = ethers.utils.formatEther(balance);
                console.log('Balance:', balanceEth, 'ETH');

                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… è¿æ¥æˆåŠŸ!';

                let details = '<div class="result-item"><span class="result-label">é’±åŒ…åœ°å€:</span> ' + address + '</div>';
                details += '<div class="result-item"><span class="result-label">ç½‘ç»œ:</span> ' + network.name + ' (Chain ID: ' + network.chainId + ')</div>';
                details += '<div class="result-item"><span class="result-label">ä½™é¢:</span> ' + balanceEth + ' ETH</div>';

                detailsDiv.innerHTML = details;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ è¿æ¥å¤±è´¥';

                let errorDetails = '<div class="error">';
                errorDetails += '<strong>é”™è¯¯ç±»å‹:</strong> ' + (error.name || 'Unknown') + '<br>';
                errorDetails += '<strong>é”™è¯¯ä¿¡æ¯:</strong> ' + error.message + '<br>';
                errorDetails += '<strong>é”™è¯¯ä»£ç :</strong> ' + (error.code || 'N/A') + '<br>';
                errorDetails += '</div>';

                if (error.code === 4001) {
                    errorDetails += `<div class="warning" style="margin-top: 10px;">
                        <strong>ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚</strong><br>
                        è¯·åœ¨ MetaMask å¼¹çª—ä¸­ç‚¹å‡»"è¿æ¥"
                    </div>`;
                } else if (error.code === -32002) {
                    errorDetails += `<div class="warning" style="margin-top: 10px;">
                        <strong>è¿æ¥è¯·æ±‚å·²åœ¨ç­‰å¾…ä¸­</strong><br>
                        è¯·æ£€æŸ¥ MetaMask æ‰©å±•,å¯èƒ½æœ‰å¾…å¤„ç†çš„è¯·æ±‚
                    </div>`;
                }

                detailsDiv.innerHTML = errorDetails;
                console.error('Connection error:', error);
            }
        }

        // Event listeners
        document.getElementById('checkNetwork').addEventListener('click', checkNetwork);
        document.getElementById('testConnect').addEventListener('click', testConnection);

        // Run initial checks
        window.addEventListener('load', () => {
            console.log('=== é’±åŒ…è¿æ¥è¯Šæ–­å·¥å…·å¯åŠ¨ ===');
            setTimeout(() => {
                checkMetaMask();
                checkEthers();
                checkConfig();
            }, 500);
        });
    </script>
</body>
</html>
