<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End Proposal è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .check-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 5px solid #ccc;
        }
        .check-item.pass {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .check-item.fail {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .check-item h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        .check-item p {
            margin: 5px 0;
            font-size: 14px;
        }
        .code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” End Proposal è¯Šæ–­å·¥å…·</h1>

        <button id="connectBtn">è¿æ¥é’±åŒ…</button>
        <div id="walletInfo" class="info" style="display:none;"></div>

        <button id="diagnoseBtn" style="display:none;">è¯Šæ–­ End Proposal æ¡ä»¶</button>

        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="./config.js"></script>
    <script>
        let provider, signer, contract, userAddress;

        const CONTRACT_ADDRESS = CONFIG.CONTRACT_ADDRESS;
        const ABI = [
            "function propertyManager() view returns (address)",
            "function currentProposal() view returns (uint16)",
            "function getCurrentProposalInfo() external view returns (uint16, string, string, bool, uint256, uint256, uint16)",
            "function getProposalResults(uint16 proposalId) external view returns (bool, uint16, uint16, uint16, bool)",
            "function isVotingActive(uint16 proposalId) external view returns (bool)",
            "function endProposal(uint16 proposalId) external"
        ];

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('è¯·å®‰è£… MetaMask!');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletInfo').innerHTML = `
                    âœ… å·²è¿æ¥é’±åŒ…: <code>${userAddress}</code>
                `;
                document.getElementById('diagnoseBtn').style.display = 'block';
            } catch (error) {
                alert('è¿æ¥å¤±è´¥: ' + error.message);
            }
        });

        document.getElementById('diagnoseBtn').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">æ£€æŸ¥ä¸­...</div>';

            try {
                // è·å–æ‰€æœ‰å¿…è¦ä¿¡æ¯
                const manager = await contract.propertyManager();
                const [proposalId, title, description, isActive, startTime, endTime, totalVotes] =
                    await contract.getCurrentProposalInfo();
                const [resultsRevealed] = await contract.getProposalResults(proposalId);
                const isVotingActive = await contract.isVotingActive(proposalId);

                const currentTime = Math.floor(Date.now() / 1000);
                const propId = proposalId.toNumber();

                let html = '<h2 style="color: #667eea;">ğŸ“Š è¯Šæ–­ç»“æœ</h2>';

                // åŸºæœ¬ä¿¡æ¯
                html += '<div class="info">';
                html += '<h3>åŸºæœ¬ä¿¡æ¯</h3>';
                html += `<p><strong>Proposal ID:</strong> ${propId}</p>`;
                html += `<p><strong>æ ‡é¢˜:</strong> ${title}</p>`;
                html += `<p><strong>å½“å‰ç”¨æˆ·:</strong> <code>${userAddress}</code></p>`;
                html += `<p><strong>ç®¡ç†å‘˜:</strong> <code>${manager}</code></p>`;
                html += '</div>';

                // æ£€æŸ¥ 1: æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                const isManager = userAddress.toLowerCase() === manager.toLowerCase();
                html += `<div class="check-item ${isManager ? 'pass' : 'fail'}">`;
                html += '<h3>æ£€æŸ¥ 1: ç®¡ç†å‘˜æƒé™</h3>';
                if (isManager) {
                    html += '<p>âœ… ä½ æ˜¯ç®¡ç†å‘˜ï¼Œæœ‰æƒé™è°ƒç”¨ endProposal</p>';
                } else {
                    html += '<p>âŒ ä½ ä¸æ˜¯ç®¡ç†å‘˜</p>';
                    html += `<p><strong>å½“å‰ç”¨æˆ·:</strong> ${userAddress}</p>`;
                    html += `<p><strong>éœ€è¦ç”¨æˆ·:</strong> ${manager}</p>`;
                    html += '<p><strong>è§£å†³æ–¹æ¡ˆ:</strong> åˆ‡æ¢åˆ°éƒ¨ç½²åˆçº¦çš„é’±åŒ…åœ°å€</p>';
                }
                html += '</div>';

                // æ£€æŸ¥ 2: Proposal ID æ˜¯å¦æœ‰æ•ˆ
                const hasProposal = propId > 0;
                html += `<div class="check-item ${hasProposal ? 'pass' : 'fail'}">`;
                html += '<h3>æ£€æŸ¥ 2: Proposal æ˜¯å¦å­˜åœ¨</h3>';
                if (hasProposal) {
                    html += `<p>âœ… Proposal ID: ${propId}</p>`;
                } else {
                    html += '<p>âŒ æ²¡æœ‰ Proposal</p>';
                    html += '<p><strong>è§£å†³æ–¹æ¡ˆ:</strong> éœ€è¦å…ˆåˆ›å»º Proposal</p>';
                }
                html += '</div>';

                // æ£€æŸ¥ 3: æŠ•ç¥¨æœŸæ˜¯å¦ç»“æŸ
                const votingEnded = currentTime > endTime.toNumber();
                html += `<div class="check-item ${votingEnded ? 'pass' : 'fail'}">`;
                html += '<h3>æ£€æŸ¥ 3: æŠ•ç¥¨æœŸæ˜¯å¦ç»“æŸ</h3>';
                html += `<p><strong>ç»“æŸæ—¶é—´:</strong> ${new Date(endTime * 1000).toLocaleString()}</p>`;
                html += `<p><strong>å½“å‰æ—¶é—´:</strong> ${new Date(currentTime * 1000).toLocaleString()}</p>`;
                if (votingEnded) {
                    const timePassed = currentTime - endTime.toNumber();
                    html += `<p>âœ… æŠ•ç¥¨æœŸå·²ç»“æŸ (${Math.floor(timePassed / 60)} åˆ†é’Ÿå‰)</p>`;
                } else {
                    const timeLeft = endTime.toNumber() - currentTime;
                    const hours = Math.floor(timeLeft / 3600);
                    const minutes = Math.floor((timeLeft % 3600) / 60);
                    html += `<p>âŒ æŠ•ç¥¨æœŸæœªç»“æŸï¼Œè¿˜å‰© ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ</p>`;
                    html += '<p><strong>è§£å†³æ–¹æ¡ˆ:</strong> ç­‰å¾…æŠ•ç¥¨æœŸç»“æŸ</p>';
                }
                html += '</div>';

                // æ£€æŸ¥ 4: ææ¡ˆæ˜¯å¦æ¿€æ´»
                html += `<div class="check-item ${isActive ? 'pass' : 'fail'}">`;
                html += '<h3>æ£€æŸ¥ 4: Proposal æ˜¯å¦æ¿€æ´»</h3>';
                if (isActive) {
                    html += '<p>âœ… Proposal å¤„äºæ¿€æ´»çŠ¶æ€</p>';
                } else {
                    html += '<p>âŒ Proposal æœªæ¿€æ´»ï¼ˆå¯èƒ½å·²ç»ç»“æŸï¼‰</p>';
                    html += '<p><strong>è¯´æ˜:</strong> å¦‚æœå·²ç»ç»“æŸï¼Œæ— éœ€å†æ¬¡è°ƒç”¨ endProposal</p>';
                }
                html += '</div>';

                // æ£€æŸ¥ 5: ç»“æœæ˜¯å¦å·²å…¬å¸ƒ
                html += `<div class="check-item ${!resultsRevealed ? 'pass' : 'fail'}">`;
                html += '<h3>æ£€æŸ¥ 5: ç»“æœæ˜¯å¦å·²å…¬å¸ƒ</h3>';
                if (!resultsRevealed) {
                    html += '<p>âœ… ç»“æœæœªå…¬å¸ƒï¼Œå¯ä»¥è°ƒç”¨ endProposal</p>';
                } else {
                    html += '<p>âŒ ç»“æœå·²ç»å…¬å¸ƒï¼Œæ— éœ€å†æ¬¡ç»“æŸ</p>';
                    html += '<p><strong>è¯´æ˜:</strong> Proposal å·²ç»è¢«å¤„ç†è¿‡äº†</p>';
                }
                html += '</div>';

                // æ€»ç»“
                const canEnd = isManager && hasProposal && votingEnded && isActive && !resultsRevealed;

                html += '<div style="margin-top: 30px; padding: 20px; border-radius: 10px; ' +
                        (canEnd ? 'background: #d4edda; border: 2px solid #28a745;' :
                                  'background: #f8d7da; border: 2px solid #dc3545;') + '">';
                html += '<h2 style="margin-top: 0;">' + (canEnd ? 'âœ… å¯ä»¥ç»“æŸ Proposal' : 'âŒ ä¸èƒ½ç»“æŸ Proposal') + '</h2>';

                if (canEnd) {
                    html += '<p>æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼Œå¯ä»¥è°ƒç”¨ endProposal å‡½æ•°</p>';
                    html += '<button onclick="tryEndProposal()" style="background: #28a745;">å°è¯•ç»“æŸ Proposal</button>';
                } else {
                    html += '<p><strong>å¤±è´¥åŸå› :</strong></p><ul style="text-align: left;">';
                    if (!isManager) html += '<li>ä½ ä¸æ˜¯ç®¡ç†å‘˜</li>';
                    if (!hasProposal) html += '<li>æ²¡æœ‰ Proposal</li>';
                    if (!votingEnded) html += '<li>æŠ•ç¥¨æœŸæœªç»“æŸ</li>';
                    if (!isActive) html += '<li>Proposal æœªæ¿€æ´»</li>';
                    if (resultsRevealed) html += '<li>ç»“æœå·²å…¬å¸ƒ</li>';
                    html += '</ul>';
                }
                html += '</div>';

                // è°ƒè¯•ä¿¡æ¯
                html += '<div class="code">';
                html += '<strong>è°ƒè¯•ä¿¡æ¯:</strong><br>';
                html += `Proposal ID: ${propId}<br>`;
                html += `Is Active: ${isActive}<br>`;
                html += `Is Voting Active: ${isVotingActive}<br>`;
                html += `Results Revealed: ${resultsRevealed}<br>`;
                html += `Manager: ${manager}<br>`;
                html += `Current User: ${userAddress}<br>`;
                html += `Is Manager: ${isManager}<br>`;
                html += `End Time: ${endTime.toString()} (${new Date(endTime * 1000).toLocaleString()})<br>`;
                html += `Current Time: ${currentTime} (${new Date(currentTime * 1000).toLocaleString()})<br>`;
                html += `Voting Ended: ${votingEnded}`;
                html += '</div>';

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">
                    <h3>è¯Šæ–­å¤±è´¥</h3>
                    <p>${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>`;
            }
        });

        window.tryEndProposal = async function() {
            if (!contract) return;

            try {
                const [proposalId] = await contract.getCurrentProposalInfo();
                const propId = proposalId.toNumber();

                if (confirm(`ç¡®è®¤è¦ç»“æŸ Proposal ${propId} å—ï¼Ÿ`)) {
                    const tx = await contract.endProposal(propId);
                    alert('äº¤æ˜“å·²æäº¤: ' + tx.hash);
                    await tx.wait();
                    alert('Proposal å·²æˆåŠŸç»“æŸï¼');
                    document.getElementById('diagnoseBtn').click();
                }
            } catch (error) {
                alert('ç»“æŸå¤±è´¥: ' + error.message);
                console.error(error);
            }
        };
    </script>
</body>
</html>
