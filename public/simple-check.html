<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Status Check</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        #result {
            margin-top: 30px;
        }
        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid;
        }
        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .loading {
            background: #e7f3ff;
            border-color: #2196F3;
            color: #014361;
        }
        .detail {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            overflow-x: auto;
        }
        .highlight {
            font-weight: bold;
            color: #667eea;
        }
        input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 200px;
            margin: 10px 5px;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Registration Status Checker</h1>
        <p class="subtitle">Check if your wallet is already registered in the voting contract</p>

        <div>
            <button onclick="quickCheck()">üîå Check My Status</button>
            <button onclick="showContractInfo()">üìú Contract Info</button>
        </div>

        <div style="margin-top: 20px;">
            <input type="number" id="unit" placeholder="Unit Number (1-200)" min="1" max="200" value="1">
            <button onclick="testRegister()">üß™ Test Registration</button>
        </div>

        <div id="result"></div>
    </div>

    <script type="module">
        import { ethers } from './lib/ethers.esm.min.js';
        const CONTRACT_ADDRESS = '0x6Ece9C29F6E47876bC3809BAC99c175273E184aB';
        const CONTRACT_ABI = [
            "function residents(address) view returns (bool isRegistered, bool hasVoted, uint256 registrationTime, uint8 encryptedUnit)",
            "function propertyManager() view returns (address)",
            "function currentProposal() view returns (uint16)",
            "function registerResident(uint8 unitNumber)",
            "function registeredResidents(uint256) view returns (address)"
        ];

        function showMessage(html, type = 'info') {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="status-box ${type}">${html}</div>`;
        }

        window.quickCheck = async function() {
            try {
                showMessage('üîÑ Connecting to MetaMask...', 'loading');

                // Check MetaMask
                if (typeof window.ethereum === 'undefined') {
                    showMessage('‚ùå <strong>MetaMask Not Found!</strong><br>Please install MetaMask extension.', 'error');
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const userAddress = accounts[0];

                // Create provider and contract
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                const balance = await provider.getBalance(userAddress);

                // Create contract instance
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

                // Get resident info
                const residentInfo = await contract.residents(userAddress);

                // Display results
                let html = '<h3>‚úÖ Status Check Complete</h3>';
                html += '<div class="detail">';
                html += `<strong>Your Address:</strong><br>${userAddress}<br><br>`;
                html += `<strong>Network:</strong> ${network.name} (Chain ID: ${network.chainId})<br>`;
                html += `<strong>Balance:</strong> ${ethers.utils.formatEther(balance)} ETH<br><br>`;
                html += `<strong>Registration Status:</strong> <span class="highlight">${residentInfo.isRegistered ? '‚úÖ REGISTERED' : '‚ùå NOT REGISTERED'}</span><br>`;

                if (residentInfo.isRegistered) {
                    const regDate = new Date(residentInfo.registrationTime.toNumber() * 1000);
                    html += `<strong>Has Voted:</strong> ${residentInfo.hasVoted ? 'Yes' : 'No'}<br>`;
                    html += `<strong>Registered On:</strong> ${regDate.toLocaleString()}<br>`;
                }

                html += '</div>';

                if (residentInfo.isRegistered) {
                    html += '<div class="status-box warning">';
                    html += '<strong>‚ö†Ô∏è You Are Already Registered!</strong><br><br>';
                    html += 'This is why you\'re getting the "execution reverted" error.<br><br>';
                    html += '<strong>Solutions:</strong><br>';
                    html += '1Ô∏è‚É£ Use a different MetaMask account<br>';
                    html += '2Ô∏è‚É£ Skip registration and start voting<br>';
                    html += '</div>';
                } else {
                    html += '<div class="status-box success">';
                    html += '<strong>‚úÖ Good News!</strong><br><br>';
                    html += 'You are NOT registered. You can proceed with registration.<br>';
                    html += 'Enter a unit number (1-200) and click "Test Registration" above.';
                    html += '</div>';
                }

                // Check network
                if (network.chainId !== 11155111) {
                    html += '<div class="status-box error">';
                    html += '<strong>‚ùå Wrong Network!</strong><br>';
                    html += 'Please switch to <strong>Sepolia Testnet</strong> in MetaMask.';
                    html += '</div>';
                }

                // Check balance
                if (balance.lt(ethers.utils.parseEther('0.001'))) {
                    html += '<div class="status-box warning">';
                    html += '<strong>‚ö†Ô∏è Low Balance!</strong><br>';
                    html += 'Get free Sepolia ETH from: <a href="https://sepoliafaucet.com" target="_blank">sepoliafaucet.com</a>';
                    html += '</div>';
                }

                showMessage(html, 'info');

            } catch (error) {
                showMessage(`‚ùå <strong>Error:</strong><br>${error.message}`, 'error');
                console.error(error);
            }
        }

        window.testRegister = async function() {
            const unitNumber = document.getElementById('unit').value;

            if (!unitNumber || unitNumber < 1 || unitNumber > 200) {
                showMessage('‚ùå Please enter a valid unit number (1-200)', 'error');
                return;
            }

            try {
                showMessage(`üß™ Testing registration for unit #${unitNumber}...`, 'loading');

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                const userAddress = await signer.getAddress();

                // First check if already registered
                const residentInfo = await contract.residents(userAddress);

                if (residentInfo.isRegistered) {
                    showMessage(`‚ùå <strong>Cannot Register!</strong><br><br>Address <code>${userAddress}</code> is already registered.<br><br>Please use a different MetaMask account.`, 'error');
                    return;
                }

                // Try static call first (doesn't cost gas)
                try {
                    await contract.callStatic.registerResident(unitNumber);
                    showMessage(`‚úÖ <strong>Test Passed!</strong><br><br>Registration for unit #${unitNumber} should work!<br><br>You can now go back to the main page and register.`, 'success');
                } catch (staticError) {
                    let errorMsg = staticError.message;

                    showMessage(`‚ùå <strong>Test Failed!</strong><br><br>Error: ${errorMsg}<br><br><strong>Possible reasons:</strong><br>‚Ä¢ Already registered<br>‚Ä¢ Invalid unit number<br>‚Ä¢ Contract restrictions`, 'error');
                }

            } catch (error) {
                showMessage(`‚ùå <strong>Error:</strong><br>${error.message}`, 'error');
                console.error(error);
            }
        }

        window.showContractInfo = async function() {
            try {
                showMessage('üìú Loading contract information...', 'loading');

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

                const manager = await contract.propertyManager();
                const currentProposal = await contract.currentProposal();

                let html = '<h3>üìú Contract Information</h3>';
                html += '<div class="detail">';
                html += `<strong>Contract Address:</strong><br>${CONTRACT_ADDRESS}<br><br>`;
                html += `<strong>Property Manager:</strong><br>${manager}<br><br>`;
                html += `<strong>Current Proposal ID:</strong> ${currentProposal}<br><br>`;
                html += `<strong>Network:</strong> Sepolia Testnet<br>`;
                html += `<strong>Chain ID:</strong> 11155111<br>`;
                html += `<strong>Explorer:</strong> <a href="https://sepolia.etherscan.io/address/${CONTRACT_ADDRESS}" target="_blank">View on Etherscan</a>`;
                html += '</div>';

                showMessage(html, 'info');

            } catch (error) {
                showMessage(`‚ùå <strong>Error:</strong><br>${error.message}`, 'error');
                console.error(error);
            }
        }

        // Auto-check on load if MetaMask is connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    // Already connected, show hint
                    showMessage('üëã Click "Check My Status" to diagnose the registration issue.', 'info');
                }
            }
        });
    </script>
</body>
</html>
