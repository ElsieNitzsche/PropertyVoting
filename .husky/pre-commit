#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit security and quality checks..."

# Run linting
echo "üìã Running linters..."
npm run lint:check || {
  echo "‚ùå Linting failed. Fix errors before committing."
  exit 1
}

# Run Solidity linting
echo "üìã Running Solidity linter..."
npx solhint 'contracts/**/*.sol' || {
  echo "‚ùå Solidity linting failed. Fix errors before committing."
  exit 1
}

# Check formatting
echo "üé® Checking code formatting..."
npx prettier --check . || {
  echo "‚ö†Ô∏è  Formatting issues found. Run 'npm run format' to fix."
  echo "Continuing with commit..."
}

# Type checking
echo "üîç Running TypeScript type checks..."
npm run typecheck || {
  echo "‚ö†Ô∏è  TypeScript errors found. Please review."
  echo "Continuing with commit..."
}

# Security check for secrets
echo "üîí Scanning for secrets..."
npx eslint --no-eslintrc --plugin no-secrets --rule 'no-secrets/no-secrets: error' . || {
  echo "‚ùå Potential secrets detected! Please remove sensitive data."
  exit 1
}

# Check for console.log in production code
echo "üîç Checking for console statements..."
if git diff --cached --name-only | grep -E '\.(js|ts)$' | xargs grep -n 'console\.log' 2>/dev/null; then
  echo "‚ö†Ô∏è  Warning: console.log statements found. Consider removing for production."
fi

# Check contract size
echo "üì¶ Checking contract sizes..."
npx hardhat size-contracts 2>/dev/null || echo "Contract size check skipped"

# Run quick tests on changed files
echo "üß™ Running quick tests..."
npm run test:quick 2>/dev/null || {
  echo "‚ö†Ô∏è  Quick tests not configured or failed."
  echo "Continuing with commit..."
}

echo "‚úÖ Pre-commit checks passed!"
