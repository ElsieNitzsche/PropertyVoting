#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸš€ Running pre-push checks..."

# Check branch name
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  echo "âš ï¸  Warning: Pushing directly to main/master branch!"
  read -p "Are you sure? (y/N): " confirm
  if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "âŒ Push cancelled."
    exit 1
  fi
fi

# Run full test suite
echo "ðŸ§ª Running full test suite..."
npm test || {
  echo "âŒ Tests failed! Fix issues before pushing."
  exit 1
}

# Security audit
echo "ðŸ”’ Running security audit..."
npm audit --audit-level=moderate || {
  echo "âš ï¸  Security vulnerabilities found. Review before pushing."
  read -p "Continue anyway? (y/N): " confirm
  if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "âŒ Push cancelled."
    exit 1
  fi
}

# Check coverage
echo "ðŸ“Š Checking test coverage..."
npm run test:coverage --silent 2>/dev/null || echo "Coverage check skipped"

# Gas report
echo "â›½ Generating gas report..."
REPORT_GAS=true npm test --silent 2>/dev/null || echo "Gas report skipped"

echo "âœ… All pre-push checks passed!"
